DROP TABLE IF EXISTS "Users" Cascade;
DROP TABLE IF EXISTS "Cards" Cascade;
DROP TABLE IF EXISTS "Shows" Cascade;
DROP TABLE IF EXISTS "Tickets" Cascade;
DROP TABLE IF EXISTS "Orders" Cascade;
DROP TABLE IF EXISTS "Vouchers" Cascade;
DROP TABLE IF EXISTS "Products" Cascade;
DROP TABLE IF EXISTS "Promotions" Cascade;
DROP TABLE IF EXISTS "ProductOrders" Cascade;
DROP TABLE IF EXISTS "Transactions" Cascade;

CREATE TABLE "Users" (
	id TEXT PRIMARY KEY,
	username TEXT NOT NULL UNIQUE,
	password TEXT NOT NULL,
	nif INTEGER NOT NULL UNIQUE,
	"keyN" TEXT NOT NULL,
	"keyE" TEXT NOT NULL,
    "createdAt" DATE,
    "updatedAt" DATE,
	UNIQUE("keyN", "keyE")
);

CREATE TABLE "Cards" (
	id TEXT PRIMARY KEY,
	type TEXT NOT NULL,
	number INTEGER NOT NULL UNIQUE,
	validity date NOT NULL,
	"userId" TEXT UNIQUE REFERENCES "Users"(id),
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "Shows" (
	id INTEGER PRIMARY KEY,
	name TEXT NOT NULL,
    url TEXT,
	description TEXT,
	date timestamp NOT NULL,
	price real NOT NULL,
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "Tickets" (
	id TEXT PRIMARY KEY,
	"seatNumber" INTEGER NOT NULL,
	"used" BOOLEAN DEFAULT FALSE,
	"showName" TEXT NOT NULL,
	"showDate" DATE NOT NULL,
	"showId" INTEGER NOT NULL REFERENCES "Shows"(id),
	"userId" TEXT NOT NULL REFERENCES "Users"(id),
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "Orders" (
	id INTEGER PRIMARY KEY,
	date timestamp NOT NULL,
	"userId" TEXT NOT NULL REFERENCES "Users"(id),
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "Vouchers" (
	id TEXT PRIMARY KEY,
	available BOOLEAN NOT NULL DEFAULT TRUE,
	"productId" INTEGER,
	"userId" TEXT NOT NULL REFERENCES "Users"(id),
	"orderId" INTEGER REFERENCES "Orders"(id),
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "Products" (
	id INTEGER PRIMARY KEY,
	name TEXT NOT NULL,
	price real NOT NULL,
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "Promotions" (
	"voucherId" TEXT NOT NULL REFERENCES "Vouchers"(id),
	"productId" INTEGER NOT NULL REFERENCES "Products"(id),
	discount real NOT NULL,
	PRIMARY KEY ("voucherId", "productId"),
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "ProductOrders" (
	"productId" INTEGER NOT NULL REFERENCES "Products"(id),
	"orderId" INTEGER NOT NULL REFERENCES "Orders"(id),
	quantity INTEGER NOT NULL,
	PRIMARY KEY ("productId", "orderId"),
        "createdAt" DATE,
        "updatedAt" DATE
);

CREATE TABLE "Transactions" (
        "productId" INTEGER REFERENCES "Products"(id),
        "ticketId" TEXT REFERENCES "Tickets"(id),
        "userId" TEXT NOT NULL REFERENCES "Users"(id),
         price real NOT NULL
);
INSERT INTO "Shows" (id, name, url, description, date, price) VALUES (1, 'Teste1', 'Its gonna be hoooot!', 'teste.png', '2019-11-16', 19.99);
INSERT INTO "Shows" (id, name, url, description, date, price) VALUES (2, 'Teste2', 'Its gonna be hoooot!', 'teste.png', '2019-11-16', 19.99);
INSERT INTO "Shows" (id, name, url, description, date, price) VALUES (3, 'Teste3', 'Its gonna be hoooot!', 'teste.png', '2019-11-16', 19.99);

INSERT INTO "Products" ("id", "name", "price") VALUES (0,'Coffe', 5);
INSERT INTO "Products" ("id", "name", "price") VALUES (1,'Popcorn', 5);